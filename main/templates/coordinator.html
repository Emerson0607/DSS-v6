{% extends "admin_dashboard.html" %}
{% block content %}
<style>
    .checked {
    text-decoration: line-through;
}
</style>
<div class="notfound">
<div class="coordinatorCard1 ">
    <div class="no-data">
        <h1>No Data Found</h1>
       
        <p>Sorry, but there is no data available at the moment. Go back to the<a href="{{url_for('dbModel.kaakbay_program')}}"> Community Project</a> page.</p>
    </div>
</div>
</div>

<div class="coordinatorCard">
    <div class="insights-div">
       
        <span class="material-symbols-sharp ">analytics </span>
        <h2 style="display:inline;" class="ml-4 lh-base text-capitalize fs-2 fw-medium " ></h2>
        
        <div class="middle">
            <div class="left">
                <h3></h3>
                <h1></h1>
            </div>
            <div class="progress">
                <svg>
                    <circle cx='38' cy='38' r='36'></circle>
                </svg>
                <div class="number">
                    <p></p>
                </div>
            </div>
        </div>
        <small class="text-muted"></small>
          <!-- Add checkboxes and labels here -->
          
        <div class="checkboxes">
            <form>
            <div class="form-group">
                <label for=""> <br>Comment </label>
                <textarea class="form-control" id="textarea" rows="1"></textarea>
                <br>
              </div>
            <div class="checkbox-group">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="" value="">
                    <label class="label" ></label>
                </div>
            </div>
            
         </form>
        </div>
       
        <button class="btn btn-primary save-button">Save</button>
    </div>
    
</div>
<div id="program-data" data-program="{{ data }}"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    
    $(document).ready(function(){
        function_name();

    });

    function function_name(){
        var program = $("#program-data").data("program");
        console.log(program);
        $.ajax({
        url: "/get_community_data",
        method: "GET",
        dataType: "json",
        data: { program: program },
        success: function(data) {
            if (data.message === 'No data found for the program.') {
            console.log('No data found.');
            $(".notfound").css("display", "block");
            return;
        } else {
        data = data.reverse();
            // Get the container where you want to append the generated divs
        var insightsContainer = $(".coordinatorCard");
    
        // Iterate through the data and generate div elements for each record
        data.forEach(function(record) {
        // Clone the template .insights-div element for each record
        var insightsDiv = $(".insights-div").clone();

        // Update the content within the newly created insights-div
        insightsDiv.find("h3").text(record.community);
        insightsDiv.find("h2").text(record.user);
        insightsDiv.find("h1").text(record.program);
        insightsDiv.find(".text-muted").text(record.subprogram);
     

        // Generate checkboxes based on the totalWeek value
        var checkboxGroup = insightsDiv.find(".checkbox-group");
        checkboxGroup.empty(); // Clear any existing checkboxes

        var lastCheckedIndex = 0; // Keep track of the last checked checkbox index

        for (var i = 1; i <= record.totalWeek; i++) {
            var checkboxContainer = $('<div class="form-check form-check-inline">');
            var checkbox = $('<input class="form-check-input" type="checkbox">');
            var label = $('<label class="label">Week ' + i + '</label>');
                
            // Set a unique ID for each checkbox, e.g., "checkbox1", "checkbox2", ...
            var checkboxId = record.subprogram;
            checkbox.attr("id", checkboxId);
                
            // Set the "for" attribute of the label to match the checkbox's ID
            label.attr("for", checkboxId);

            // Append the checkbox to the container, and the container to the checkboxGroup
            checkboxContainer.append(checkbox);
            checkboxContainer.append(label);


            // Add a class to the label for easier selection
            label.addClass("checkbox-label");

            // Check and disable checkboxes up to record.week
             if (record.week === 0 || record.week === undefined) {
                // If record.week is 0 or undefined, allow checking the first checkbox
                if (i === 1) {
                    checkbox.prop("checked", false);
                } else {
                    checkbox.prop("disabled", true);
                }
            } else {
                // Check and disable checkboxes up to record.week
                if (i <= record.week) {
                    checkbox.prop("checked", true);
                    label.addClass("checked");
                } else {
                    checkbox.prop("disabled", true);
                }
            }

            // Use event delegation to handle changes to checkboxes
            checkboxGroup.on("change", ".form-check-input", function() {
                var checkbox = $(this);
                var label = checkbox.siblings(".checkbox-label");

                if (checkbox.prop("checked")) {
                    label.addClass("checked");
                } else {
                    label.removeClass("checked");
                }

                
            });

            checkbox.on("change", function() {
                if (this.checked) {
                    var currentIndex = i;
                    lastCheckedIndex = currentIndex;
                } else {
                    this.checked = true;
                }
            });
            
            checkboxGroup.append(checkboxContainer);
        } //end for

        /* # This is use if there's a default value of week*/


        
        var checkboxes = checkboxGroup.find("input:checkbox");
        checkboxes.on("change", function () {
            if (this.checked) {
                var currentIndex = checkboxes.index(this);
                console.log(currentIndex);
                // Enable the next checkbox if it exists and is not already checked
                if (currentIndex < checkboxes.length - 1) {
                    var nextCheckbox = checkboxes.eq(currentIndex + 1);
                    if (!nextCheckbox.prop("checked")) {
                        nextCheckbox.prop("disabled", false);
                    }
                }
            }
        });

       

         // Add a click event handler for saving data to the database
        insightsDiv.find(".save-button").click(function () {
            var textareaValue = insightsDiv.find("#textarea").val();

            if (textareaValue.trim() === "") {
                alert("Please input data in the textarea before saving.");
            } else {
                updatePercentage();
                saveDataToDatabase(textareaValue);
            }
        });

        function saveDataToDatabase(textareaValue) {
            setTimeout(function () {
                insightsDiv.find("#textarea").val("");

                var alertElement =  '<div role="alert">' + '<h4>Save Success</h4>' + '</div>';

                insightsDiv.append(alertElement);
                setTimeout(function () {
                    insightsDiv.find(".alert.alert-success").remove();
                }, 3000); 
            }, 1000); 
        }


        var checkedCheckboxes = checkboxGroup.find("input:checkbox:checked").length;
        var totalCheckboxes = checkboxGroup.find("input:checkbox").length;
        var percentage = Math.floor((checkedCheckboxes * 100) / totalCheckboxes);
        insightsDiv.find(".number").text(percentage + "%");

        function updatePercentage() {
            var checkedCheckboxes = checkboxGroup.find("input:checkbox:checked").length;
            var totalCheckboxes = checkboxGroup.find("input:checkbox").length;
            var percentage = Math.floor((checkedCheckboxes * 100) / totalCheckboxes);
            insightsDiv.find(".number").text(percentage + "%");

            var circle = insightsDiv.find("circle");
            var circumference = 2 * Math.PI * parseInt(circle.attr("r"));
            var dashOffset = circumference * (1 - percentage / 100);

            circle.attr("stroke-dasharray", circumference);
            circle.attr("stroke-dashoffset", dashOffset);

            if (percentage >= 85) {
                circle.attr("stroke", "#41f1b6"); // Green
                } else if (percentage >= 70) {
                circle.attr("stroke", "#ffbb55"); // Orange
                } else if (percentage >= 40) {
                circle.attr("stroke", "#ff7782"); // Pink
                } else {
                circle.attr("stroke", "red"); // Red
                }
        
            $.ajax({
                url: "/update_week",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    subprogram: record.subprogram,
                    totalCheckboxes: checkedCheckboxes
                }),
                success: function(response) {
                    console.log("Week updated successfully.");
                },
                    error: function(error) {
                        console.error("Failed to update week: " + error);
                    }
            }); 
        }

            var circle = insightsDiv.find("circle");
            var circumference = 2 * Math.PI * parseInt(circle.attr("r"));
            var dashOffset = circumference * (1 - percentage / 100);

            circle.attr("stroke-dasharray", circumference);
            circle.attr("stroke-dashoffset", dashOffset);

            if (percentage >= 85) {
                circle.attr("stroke", "#41f1b6"); // Green
                } else if (percentage >= 70) {
                circle.attr("stroke", "#ffbb55"); // Orange
                } else if (percentage >= 40) {
                circle.attr("stroke", "#ff7782"); // Pink
                } else {
                circle.attr("stroke", "red"); // Red
                }

                insightsContainer.append(insightsDiv);
                insightsDiv.removeClass("insights-div");
            });

            insightsContainer.find("> div:first-child").css("display", "none");
        }
    },
    error: function() {
        console.log("Failed to load community data.");
    }
    });
    }
</script>
{% endblock %}