{% extends "admin_dashboard.html" %}
{% block title %}Community Programs{% endblock %}
{% block content %}
<style>
    .checked {
        text-decoration: line-through;
    }

    /* HTML: <div class="loader"></div> */
    .loader {
        width: 40px;
        aspect-ratio: 1;
        border-radius: 50%;
        background: #f03355;
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        animation: l1 2s infinite cubic-bezier(0.3, 1, 0, 1);
    }

    @keyframes l1 {
        33% {
            border-radius: 0;
            background: #514b82;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%)
        }

        66% {
            border-radius: 0;
            background: #ffa516;
            clip-path: polygon(50% 0, 50% 0, 100% 100%, 0 100%)
        }
    }
</style>

<div class="notfound1">
    <div class="notfound">
        <div class="no-data">
            <h1>No Data Found</h1>
            <p>Sorry, but there is no data available at the moment. Go back to the
                <a href="{{url_for('dbModel.kaakbay_program')}}"> Community Project</a>page.
            </p>
        </div>

    </div>
</div>
<div class="margin-top"></div>
{% with messages = get_flashed_messages(category_filter=['existing_username', 'existing_program',
'edit_account',
'delete_account', 'add_account', 'password_space', 'username_space'], with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="flash flash-{{ category }}" style="margin-bottom: 1rem;">
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}
<div class="kaakbay-subprogram-title">

    <h1>Fundraising Programs</h1>
    <svg class="kaakbay-design-title" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
        <path fill="#303396" fill-opacity="1"
            d="M0,256L48,240C96,224,192,192,288,202.7C384,213,480,267,576,266.7C672,267,768,213,864,197.3C960,181,1056,203,1152,224C1248,245,1344,267,1392,277.3L1440,288L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z">
        </path>
    </svg>
</div>
<div class="coordinatorCard">


    <div class="insights-div ">

        <p class="community-status"></p>
        <div class="community-subprogram-title">
            <div class="subLogo">
                <span class="material-symbols-sharp ">analytics</span>
            </div>
            <h2 class="community-subprogram"></h2>
        </div>
        <div class="middle">
            <div class="left">
                <h3 class="community-department"></h3>
                <small class="community-title"></small>
            </div>
            <div class="progress">
                <div class="loader ongoing"></div>
                <div class="loader completed"></div>
            </div>
        </div>
        <div class="date-card">
            <div class="date-title start-title-green">START DATE</div>
            <div class="date-title end-title-red">END DATE</div>

            <div class="date-card-content start-date-card">
                <div class="box-color-green"></div>
                <div class="date-content">
                    <small class="text-muted community-start_date"></small>
                </div>
            </div>
            <div class="date-card-content end-date-card">
                <div class="box-color-red"></div>
                <div class="date-content">
                    <small class="text-muted community-end_date"></small>
                </div>
            </div>
        </div>

        <div class="jumbotron">
            <h2 style="margin-bottom: 1rem;">Fundraising <b>Donor</b></h2>
            <div class="table-card">
                <table class="table" id="donor-table">
                    <thead>
                        <tr>
                            <th>Program</th>
                            <th>Name</th>
                            <th>Donation</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <!--end add modal account-->
            <span class="swipe-indicator swipe">&#8592; Swipe Left or Right &#8594;</span>
        </div>




        <!-- Add checkboxes and labels here -->
        <div class="donor_cash_card">
            <h1>Cash</h1>
            <div class="donor_qty">
                <input type="text" class="form-control">
                <button class="btn-primary">Add</button>
            </div>
            <div class="donor_details">
                <div class="donor_list">

                </div>
            </div>
        </div>

        <div class="donor_inkind_card">
            <h1>In-Kind</h1>
            <div class="donor_qty">
                <input type="text" class="form-control">
                <button class="btn-primary">Add</button>
            </div>
            <div class="donor_details">
                <div class="donor_list">


                </div>
            </div>

        </div>

        <input type="text" class="link-input" placeholder="Enter Link">
        <button class="btn btn-primary save-button">Save</button>
        <button class="btn btn-primary archive-button">Archive</button>
    </div>

</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        function_name();
    });

    function function_name() {
        $.ajax({
            url: "/get_fund_data",
            method: "GET",
            dataType: "json",
            success: function (data) {
                if (data.message === 'There are no active projects available for display.') {
                    $(".notfound1").css("display", "block");
                    $(".kaakbay-subprogram-title").css("display", "none");

                    return;
                } else {

                    data = data.reverse();
                    var insightsContainer = $(".coordinatorCard");
                    data.forEach(function (record) {
                        var insightsDiv = $(".insights-div").clone();
                        var proposed_date = new Date(record.proposed_date);
                        var target_date = new Date(record.target_date);
                        // Format the dates to display only the date portion
                        var proposed_date_string = proposed_date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        var target_date_string = target_date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

                        var statusText = record.status;
                        var colorClass = statusText === 'Ongoing' ? 'text-orange' : 'text-green';

                        if (statusText === 'Ongoing') {
                            insightsDiv.find(".archive-button").css("display", "none");
                            insightsDiv.find(".save-button").css("display", "block");
                        } else if (statusText === 'Completed') {
                            insightsDiv.find(".save-button").css("display", "none");
                            insightsDiv.find(".archive-button").css("display", "block");
                            insightsDiv.find(".link-input").css("display", "block");
                        }

                        // Update the content within the newly created insights-div

                        insightsDiv.find(".community-subprogram").text(record.project_name);
                        insightsDiv.find(".community-department").text(record.program);
                        insightsDiv.find(".community-title").text(record.coordinator);
                        insightsDiv.find(".community-start_date").text(proposed_date_string);
                        insightsDiv.find(".community-end_date").text(target_date_string);
                        insightsDiv.find(".community-status").text(statusText).addClass(colorClass);

                        var checkboxGroup = insightsDiv.find(".checkbox-group");
                        checkboxGroup.empty(); // Clear any existing checkboxes
                        var lastCheckedIndex = 0; // Keep track of the last checked checkbox index

                        // Add a click event handler for saving data to the database
                        insightsDiv.find(".save-button").click(function () {
                            var userConfirmed = confirm("Are you sure you want to proceed?");

                            if (userConfirmed) {
                                update_fund();
                            }
                        });


                        // Hide donor_cash_card or donor_inkind_card based on donation_type
                        if (record.donation_type === 'Cash') {
                            insightsDiv.find('.donor_inkind_card').hide();
                        } else if (record.donation_type === 'In-Kind') {
                            insightsDiv.find('.donor_cash_card').hide();
                        }

                        insightsDiv.find(".donor_qty button").click(function () {
                            var qty = parseInt($(this).siblings("input").val()); // Get the quantity entered by the user
                            if (!isNaN(qty) && qty > 0) { // Check if the entered value is a valid number
                                var fieldsToAdd = qty; // Calculate the total number of fields to add (4 fields per donor)
                                for (var i = 0; i < fieldsToAdd; i++) {
                                    var inputField = $("<div>").addClass("input-group mb-3");

                                    // Label for Name
                                    var nameLabel = $("<label>").addClass("form-label").text("Name");
                                    var nameInput = $("<input>").attr("type", "text").addClass("form-control name-input");

                                    // Label for Donation
                                    var donationLabel = $("<label>").addClass("form-label").text("Donation");
                                    var donationInput = $("<input>").attr("type", "text").addClass("form-control donation-input");

                                    // Label for Date
                                    var dateLabel = $("<label>").addClass("form-label").text("Date");
                                    var dateInput = $("<input>").attr("type", "date").addClass("form-control date-input");

                                    var button = $("<button>").addClass("btn btn-danger delete-button").text("Delete");

                                    // Append labels and input fields to the input group
                                    inputField.append(nameLabel).append(nameInput);
                                    inputField.append(donationLabel).append(donationInput);
                                    inputField.append(dateLabel).append(dateInput);
                                    inputField.append(button); // Append delete button to the input group

                                    // Append input group to the donor list
                                    insightsDiv.find(".donor_list").append(inputField);
                                }

                                // Clear the input value after adding input fields
                                $(this).siblings("input").val("");
                            } else {
                                alert("Please enter a valid quantity.");
                            }
                        });



                        // Deleting input fields from the donor list
                        insightsDiv.on("click", ".delete-button", function () {
                            var inputFields = $(this).closest(".donor_list").find(".input-group");
                            if (inputFields.length > 1) { // Check if there is more than one input field
                                $(this).parent().remove(); // Remove the parent div containing the input field and delete button
                            } else {
                                alert("At least one donor field must remain.");
                            }
                        });

                        var fundId = null;
                        record.donors.forEach(function (donor) {
                            if (donor.fund_id) { // Check if fund_id exists
                                fundId = donor.fund_id; // Store the fund_id in the variable
                            }
                        });

                        // Populate the donor table only if record.id matches fund_id from donor_cash
                        if (record.id === fundId) {
                            var donorTableBody = insightsDiv.find("#donor-table tbody");
                            // Clear the existing content of the donor table before populating it with new data
                            donorTableBody.empty();
                            record.donors.forEach(function (donor) {
                                var row = $("<tr>");
                                row.append($("<td>").text(record.program));
                                row.append($("<td>").text(donor.name));
                                row.append($("<td>").text(donor.donation));
                                row.append($("<td>").text(donor.date));
                                donorTableBody.append(row);
                            });
                        }


                        // Check if status is "Completed"
                        if (record.status === "Completed") {
                            // Hide donor_cash_card and donor_inkind_card
                            insightsDiv.find('.donor_cash_card').hide();
                            insightsDiv.find('.donor_inkind_card').hide();
                        }



                        // archive project
                        insightsDiv.find(".archive-button").click(function () {
                            // Select the input field based on its parent container
                            var linkInput = insightsDiv.find(".link-input").val().trim();

                            if (linkInput === "") {
                                console.log("URL is empty.");
                                alert("Please enter a URL before archiving the project.");
                            } else {
                                var userConfirmed = confirm("Are you sure you want to proceed?");
                                if (userConfirmed) {
                                    // Execute update_status and updatePercentage if the user confirmed
                                    archive_project(linkInput); // Pass the URL input value to the archive_project function
                                }
                            }
                        });

                        function archive_project(url) {
                            var recordStatus = "Completed";
                            $.ajax({
                                url: "/archive_fund_donor",
                                method: "POST",
                                contentType: "application/json",
                                data: JSON.stringify({
                                    id: record.id,
                                    program: record.program,
                                    project_name: record.project_name,
                                    coordinator: record.coordinator,
                                    status: recordStatus,
                                    url: url // Include the URL in the data to be sent to the server
                                }),
                                success: function (response) {
                                    console.log("Status updated successfully.");
                                    location.reload();
                                },
                                error: function (error) {
                                    console.error("Failed to update status: ");
                                    alert("Invalid URL format. Please enter a valid URL starting with http:// or https:// and containing a valid domain.");
                                }
                            });
                        }

                        function update_fund() {
                            var recordStatus = "Completed";
                            var donorData = []; // Array to store donor data

                            // Iterate over each input field in the donor list
                            insightsDiv.find(".donor_cash_card .donor_list .input-group").each(function () {
                                // Retrieve the values from the input fields
                                var name = $(this).find(".name-input").val().trim();
                                var donation = $(this).find(".donation-input").val().trim();
                                var date = $(this).find(".date-input").val().trim();

                                // Check if all fields are non-empty
                                if (name !== "" && donation !== "" && date !== "") {
                                    // Construct an object representing donor data and add it to the array
                                    donorData.push({
                                        name: name,
                                        donation: donation,
                                        date: date
                                    });
                                }
                            });

                            // Send the donorData array to the server
                            $.ajax({
                                url: "/update_fund",
                                method: "POST",
                                contentType: "application/json",
                                data: JSON.stringify({
                                    id: record.id,
                                    program: record.program,
                                    coordinator: record.coordinator,
                                    status: recordStatus,
                                    donation_type: record.donation_type, // Specify the donation type as "Cash"
                                    donors: donorData
                                }),
                                success: function (response) {
                                    console.log("Status updated successfully.");
                                    location.reload();
                                },
                                error: function (error) {
                                    console.error("Failed to update status: " + error);
                                }
                            });
                        }




                        insightsContainer.append(insightsDiv);
                        insightsDiv.removeClass("insights-div");
                    });

                    insightsContainer.find("> div:first-child").css("display", "none");

                }


            },
            error: function () {
                console.log("Failed to load community data.");
            }
        });
    }
</script>
{% endblock %}